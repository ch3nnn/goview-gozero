var D=Object.defineProperty,K=Object.defineProperties;var x=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var O=(t,e,n)=>e in t?D(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,U=(t,e)=>{for(var n in e||(e={}))H.call(e,n)&&O(t,n,e[n]);if(M)for(var n of M(e))J.call(e,n)&&O(t,n,e[n]);return t},A=(t,e)=>K(t,x(e));var h=(t,e,n)=>new Promise((s,T)=>{var y=c=>{try{p(n.next(c))}catch(o){T(o)}},I=c=>{try{p(n.throw(c))}catch(o){T(o)}},p=c=>c.done?s(c.value):Promise.resolve(c.value).then(y,I);p((n=n.apply(t,e)).next())});import{k as j,aw as q,aM as g,aZ as E,cE as Q,cF as W,R as P,aK as Z,L as R,aL as b,a9 as z,cG as X,a2 as Y,cw as w,aV as L,aW as V}from"./index-312a31dd.js";import{u as tt,a as et,P as l,f as u,C as N,g as at}from"./chartEditStore-32c50897.js";import{u as ot,C as B}from"./chartLayoutStore-a3dfb071.js";import{f as nt,d as rt,e as it}from"./index-5e1011db.js";import{b as st,u as G,s as dt,f as ft}from"./project.api-bec812dd.js";const ct=t=>t,St=(t,e)=>{try{if(e.id){const n="vnodeBeforeMount"in e.events,s="vnodeMounted"in e.events;return n&&(t.events.advancedEvents.vnodeBeforeMount=e==null?void 0:e.events.vnodeBeforeMount),s&&(t.events.advancedEvents.vnodeMounted=e==null?void 0:e.events.vnodeMounted),(n||s)&&(e.events={baseEvent:{[L.ON_CLICK]:void 0,[L.ON_DBL_CLICK]:void 0,[L.ON_MOUSE_ENTER]:void 0,[L.ON_MOUSE_LEAVE]:void 0},advancedEvents:{[V.VNODE_MOUNTED]:void 0,[V.VNODE_BEFORE_MOUNT]:void 0},interactEvents:[]}),t}}catch(n){return t}},m=(t,e,n=!1)=>{if(St(t,e),n)return w(t,e);const s=e.option;if(!s)return w(t,e);if(e.option=void 0,s)return A(U({},w(t,e)),{option:s})},vt=()=>{const t=tt(),e=et(),n=j(),s=ot(),T=(o,S=!1,f=!1)=>h(void 0,null,function*(){S&&(t.componentList=[],e.clearBackStack(),e.clearForwardStack()),o.editCanvasConfig=ct(o.editCanvasConfig),o.componentList.forEach(a=>h(void 0,null,function*(){const i=r=>{window.$vue.component(r.chartConfig.chartKey)||(window.$vue.component(r.chartConfig.chartKey,nt(r.chartConfig)),window.$vue.component(r.chartConfig.conKey,rt(r.chartConfig)))};a.isGroup?a.groupList.forEach(r=>{i(r)}):i(a)}));const C=(a,i)=>h(void 0,null,function*(){let r=yield it(a.chartConfig);a.chartConfig.redirectComponent&&(a.chartConfig.dataset&&(r.option.dataset=a.chartConfig.dataset),r.chartConfig.title=a.chartConfig.title,r.chartConfig.chartFrame=a.chartConfig.chartFrame),i?i(f?m(r,A(U({},a),{id:R()})):m(r,a)):f?t.addComponentList(m(r,A(U({},a),{id:R()})),!1,!0):t.addComponentList(m(r,a),!1,!0)});for(const a in o)if(a===N.COMPONENT_LIST){let i=0;const r=o[a].length;for(const d of o[a]){let _=parseInt((parseFloat(`${++i/r}`)*100).toString());if(s.setItemUnHandle(B.PERCENTAGE,_),d.isGroup){let v=new at;f?v=m(v,A(U({},d),{id:R()})):v=m(v,d);const F=[];for(const $ of d.groupList)yield C($,k=>{F.push(k)});v.groupList=F,t.addComponentList(v,!1,!0)}else yield C(d);_===100&&(e.clearBackStack(),e.clearForwardStack())}}else(a===N.EDIT_CANVAS_CONFIG||a===N.REQUEST_GLOBAL_CONFIG)&&m(t[a],o[a],!0);s.setItemUnHandle(B.PERCENTAGE,0)}),y=o=>{const{id:S,projectName:f,remarks:C,indexImage:a,state:i}=o;t.setProjectInfo(l.PROJECT_ID,S),t.setProjectInfo(l.PROJECT_NAME,f),t.setProjectInfo(l.REMARKS,C),t.setProjectInfo(l.THUMBNAIL,a),t.setProjectInfo(l.RELEASE,i===1)},I=()=>h(void 0,null,function*(){t.componentList=[],t.setEditCanvas(u.SAVE_STATUS,E.START);try{const o=yield ft({projectId:g()});if(o&&o.code===P.SUCCESS){if(o.data){y(o.data),yield T(b(o.data.content));return}else t.setProjectInfo(l.PROJECT_ID,g());setTimeout(()=>{t.setEditCanvas(u.SAVE_STATUS,E.SUCCESS)},1e3);return}t.setEditCanvas(u.SAVE_STATUS,E.FAILURE)}catch(o){t.setEditCanvas(u.SAVE_STATUS,E.FAILURE),z()}}),p=q((o=!0)=>h(void 0,null,function*(){if(!g())return;let S=t.getProjectInfo[l.PROJECT_ID];if(S===null||S===""){window.$message.error("数据初未始化成功,请刷新页面！");return}t.setEditCanvas(u.SAVE_STATUS,E.START);try{if(o){const a=document.querySelector(".go-edit-range"),i=yield Q(a,{backgroundColor:null,allowTaint:!0,useCORS:!0});let r=new FormData;r.append("object",W(i.toDataURL(),`${g()}_index_preview.png`));const d=yield st(r);d&&d.code===P.SUCCESS&&(d.data.fileurl?yield G({id:g(),indexImage:`${d.data.fileurl}`}):yield G({id:g(),indexImage:`${n.getFetchInfo.OSSUrl}${d.data.fileName}`}))}}catch(a){console.log(a)}let f=new FormData;f.append("projectId",S),f.append("content",Z(t.getStorageInfo()||{}));const C=yield dt(f);if(C&&C.code===P.SUCCESS){setTimeout(()=>{t.setEditCanvas(u.SAVE_STATUS,E.SUCCESS)},1e3);return}t.setEditCanvas(u.SAVE_STATUS,E.FAILURE)}),3e3);return{updateComponent:T,updateStoreInfo:y,dataSyncFetch:I,dataSyncUpdate:p,intervalDataSyncUpdate:()=>{const o=setInterval(()=>{p()},X*1e3);Y(()=>{clearInterval(o)})}}};export{vt as u};
